---
- name: Provision dev machine infrastructure
  hosts: all
  become: true

  pre_tasks:
    - name: Initialize playbook
      any_errors_fatal: true
      block:
        - name: Ensure running distribution is Arch Linux
          ansible.builtin.assert:
            that: ansible_distribution == "Archlinux"

        - name: Get user {{ user }}
          ansible.builtin.getent:
            database: passwd
            key: "{{ user }}"

  tasks:
    - name: Run roles from vars
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop: "{{ run }}"

  post_tasks:
    - name: Install packages
      community.general.pacman:
        name: "{{ packages }}"
        state: present
      when: packages | length > 0

    - name: Install flatpaks
      community.general.flatpak:
        name: "{{ flatpaks }}"
        state: present
      when: flatpaks | length > 0
