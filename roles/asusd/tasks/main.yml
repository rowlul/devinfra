---
- name: Import g14 repository key
  community.general.pacman_key:
    id: 8F654886F17D497FEFE3DB448B15A6B0E9A3FA35
    keyserver: keyserver.ubuntu.com
    state: present

- name: Include g14 repository in pacman.conf
  ansible.builtin.blockinfile:
    path: /etc/pacman.conf
    prepend_newline: true
    append_newline: true
    marker: "# {mark} ANSIBLE MANAGED BLOCK :: G14"
    insertbefore: "^# BEGIN ANSIBLE MANAGED BLOCK :: CHAOTIC_AUR$"
    block: |
      [g14]
      Server = https://arch.asus-linux.org

- name: Refresh pacman cache
  community.general.pacman:
    update_cache: true

- name: Install packages
  community.general.pacman:
    name:
      - power-profiles-daemon
      - asusctl
      - supergfxctl
      - switcheroo-control
      - rog-control-center
    state: present

- name: Copy supergfxctl.conf
  ansible.builtin.copy:
    src: supergfxd.conf
    dest: /etc/supergfxd.conf
    mode: '0644'

- name: Enable and start services
  ansible.builtin.systemd:
    name: "{{ item }}.service"
    state: started
    enabled: true
  loop:
    - power-profiles-daemon
    - asusd
    - supergfxd
    - switcheroo-control

- name: Set charge limit
  ansible.builtin.command:
    cmd: "asusctl -c {{ asusd_charge_limit }}"
  when: asusd_charge_limit >= 40

- name: Set fan curves
  ansible.builtin.command:
    cmd: "asusctl fan-curve -m {{ item.mode }} -f {{ item.fan }} -D {{ item.data }} -e true"
  loop: "{{ asusd_fan_curve }}"

- name: Toggle anime
  ansible.builtin.command:
    cmd: "asusctl -c {{ asusd_anime_enabled }}"

- name: Set boot sound
  ansible.builtin.command:
    cmd: "asusctl -c {{ asusd_boot_sound }}"

- name: Set screen overdrive
  ansible.builtin.command:
    cmd: "asusctl -c {{ asusd_screen_overdrive }}"
